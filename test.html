<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ko">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
<title>JSSpec results</title>
<link rel="stylesheet" type="text/css" href="jsscript/JSSpec.css" />
<script type="text/javascript" src="jsscript/diff_match_patch.js"></script>
<script type="text/javascript" src="jsscript/JSSpec.js"></script>
<script type="text/javascript" src="vurm.js"></script>
<script type="text/javascript">// <![CDATA[

describe('translate abc prefix to notes', {
        'before': function () {
            noteReader = new AbcNoteReader();
        },
        "reads C properly": function(){
            value_of(noteReader.convert("Czzzz")).should_be({ chars: 1, note: 60 });
        },
        "reads c properly": function(){
            value_of(noteReader.convert("czzzz")).should_be({ chars: 1, note: 60 + 12 });
        },
        "reads e,, properly": function(){
            value_of(noteReader.convert("E,,zzzz")).should_be({ chars: 3, note: 60 + 4 - 12 - 12 });
        },
        "reads A' properly": function(){
            value_of(noteReader.convert("A'zzzz")).should_be({ chars: 1, note: 60 + 9 });
        },
        "ignores ' properly": function(){
            value_of(noteReader.convert("'zzzz")).should_be(null);
        },
    }
);

describe('translate abc prefix to chunks', {
        'before': function () {
            chunkReader = new AbcChunkReader();
        },
        "reads C properly": function(){
            value_of(chunkReader.convert("Czzzz")).should_be({
                chars: 1,
                notes: [ {note:60, duration:1}, ]
            });
        },
        "reads C,, properly": function(){
            value_of(chunkReader.convert("C,,zzzz")).should_be({
                chars: 3,
                notes: [ {note:60-12-12, duration:1}, ]
            });
        },
        "reads C,>d'xx properlee": function(){
            value_of(chunkReader.convert("C,>d'xx")).should_be({
                chars: 5,
                notes: [
                    {note:60-12, duration:1.5},
                    {note:60+2+12+12, duration:0.5},
                ]
            });
        },
        "reads C,<d'xx properlee": function(){
            value_of(chunkReader.convert("C,<<d'xx")).should_be({
                chars: 6,
                notes: [
                    {note:60-12, duration:0.25},
                    {note:60+2+12+12, duration:1.75},
                ]
            });
        },
        "reads aBc,D' properly": function(){
            value_of(chunkReader.convert("aBc,D'")).should_be({
                chars: 1,
                notes: [ {note:60+12+9, duration:1}, ]
            });
        },
    }
);


// Aim: something equivalent to ABC, but better for editing.
var vurm = {
        header : {
            key : 0, // -6..+6 FCGDAEB ; (?) informative only
        },
        stream : [
            {
                note: 60, // Middle C; (?) all sharps and flats are explicit despite key signature.
                duration: 1, // 1 is a crotchet. Consider 96 as a crotchet for easy triples, or fractions.
            } // , ...
        ]
    };

describe('translate abc to vurm', {
        'before': function () {
            abcToVurm = new AbcReader();
        },
        "reads C properly": function(){
            value_of(abcToVurm.convert("C")).should_be({
                stream : [ {note:60, duration:1} ]
            });
        },
        "reads C, properly": function(){
            value_of(abcToVurm.convert("C,")).should_be({
                stream : [ {note:60-12, duration:1} ]
            });
        },
        "reports parse error": function(){
            value_of(abcToVurm.convert("C'")).should_be({
                stream : [
                    {note:60, duration:1},
                    {parseFailAt:"'"}
                ]
            });
        },
        "reads aBc,D' properly": function(){
            value_of(abcToVurm.convert("aBc'D,")).should_be({
                stream : [
                    {note:81, duration:1},
                    {note:71, duration:1},
                    {note:84, duration:1},
                    {note:50, duration:1}
                ]
            });
        },
    }
);

// See MIDI.js/inc/jasmid/midifile.js
var midifile =
	{
		'header': {
            'formatType': 1,
            'trackCount': 2,
            'ticksPerBeat': 64 // per crotchet
        },
		'tracks': [
            [
                {
                    'deltaTime': 0,
                    'type': 'channel',
                    'subtype': 'noteOn',
                    'noteNumber': 40,
                    'velocity': 0
                },
                {
                    'deltaTime': 64,
                    'type': 'channel',
                    'subtype': 'noteOff',
                    'noteNumber': 40,
                    'velocity': 127
                } // , ...
            ],
            [] // , ...
        ]
	};


describe('translate vurm to midi', {
        'before': function () {
            vurmToMidi = new VurmToMidi();
        },
        "One note stream": function(){
            value_of(vurmToMidi.convert({
                stream : [ {note:60, duration:1} ]
            })).should_be({
                header: {
                    formatType: 1,
                    trackCount: 2,
                    ticksPerBeat: 64 // per crotchet, ie 64*vurm.duration
                },
                tracks: [
                    [
                        // Meta: title, key, etc.
                    ],
                    [
                        { deltaTime: 0,  type: 'channel', subtype: 'noteOn',  noteNumber: 60, velocity: 127 },
                        { deltaTime: 64, type: 'channel', subtype: 'noteOff', noteNumber: 60, velocity: 0 },
                    ],
                ]
            });
        },
        "no-repeat multi-note stream": function(){
            value_of(vurmToMidi.convert({
                stream : [
                    {note:60, duration:1},
                    {note:62, duration:1},
                ],
            })).should_be({
                header: {
                    formatType: 1,
                    trackCount: 2,
                    ticksPerBeat: 64 // per crotchet, ie 64*vurm.duration
                },
                tracks: [
                    [
                        // Meta: title, key, etc.
                    ],
                    [
                        { deltaTime: 64*0, type: 'channel', subtype: 'noteOn',  noteNumber: 60, velocity: 127 },
                        { deltaTime: 64*1, type: 'channel', subtype: 'noteOff', noteNumber: 60, velocity: 0 },
                        { deltaTime: 64*1, type: 'channel', subtype: 'noteOn',  noteNumber: 62, velocity: 127 },
                        { deltaTime: 64*2, type: 'channel', subtype: 'noteOff', noteNumber: 62, velocity: 0 },
                    ],
                ]
            });
        },
    }
);


// ]]></script>
</head>
<body><div style="display:none;"><p>A</p><p>B</p></div></body>
</html>
